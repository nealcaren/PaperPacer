{% extends "base.html" %}

{% block title %}{{ selected_date.strftime('%B %d, %Y') }} - PaperPacer{% endblock %}

{% block content %}
<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h2>📅 {{ selected_date.strftime('%A, %B %d, %Y') }}</h2>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">← Back to Calendar</a>
    </div>
    
    {% if is_today %}
        <div style="background: var(--primary-color); color: white; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 2rem; text-align: center;">
            <strong>🎯 Today's Focus</strong>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">This is today! You can mark tasks as completed below.</p>
        </div>
    {% elif selected_date < today and day_tasks|selectattr('completed', 'equalto', false)|list|length > 0 %}
        <div style="background: var(--warning-color); color: white; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 2rem; text-align: center;">
            <strong>📝 Catch-Up Mode</strong>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Mark any work you completed on this day and add notes about your progress.</p>
        </div>
    {% endif %}
    
    <div class="grid grid-2">
        <div>
            <h3>📋 Scheduled Tasks</h3>
            {% if day_tasks %}
                <form action="{{ url_for('submit_progress') }}" method="POST" id="task-form">
                    <input type="hidden" name="date" value="{{ selected_date.strftime('%Y-%m-%d') }}">
                    
                    <!-- Quick Actions for Task Management -->
                    {% set has_incomplete_tasks = day_tasks|selectattr('completed', 'equalto', false)|list|length > 0 %}
                    {% if (is_today or selected_date < today) and has_incomplete_tasks %}
                    <div class="task-quick-actions" style="margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: var(--border-radius);">
                        <div class="flex gap-2">
                            <button type="button" onclick="markAllTasksComplete()" class="btn btn-secondary" style="flex: 1;">
                                ✅ Mark All Complete
                            </button>
                            <button type="button" onclick="markAllTasksIncomplete()" class="btn btn-secondary" style="flex: 1;">
                                ↩️ Mark All Incomplete
                            </button>
                        </div>
                    </div>
                    {% endif %}

                    <div style="space-y: 1rem;">
                        {% for task in day_tasks %}
                            <div class="task-item task-status-{{ task.status or 'not_started' }}" id="task-container-{{ task.id }}">
                                <div class="flex items-start gap-3" style="width: 100%;">
                                    <div class="task-status-controls">
                                        {% if is_today or selected_date < today %}
                                        <div class="status-dropdown">
                                            <select onchange="updateTaskStatus({{ task.id }}, this.value)" class="task-status-select">
                                                <option value="not_started" {% if (task.status or 'not_started') == 'not_started' %}selected{% endif %}>📋 Not Started</option>
                                                <option value="in_progress" {% if (task.status or 'not_started') == 'in_progress' %}selected{% endif %}>🔄 In Progress</option>
                                                <option value="completed" {% if (task.status or 'not_started') == 'completed' %}selected{% endif %}>✅ Completed</option>
                                                <option value="deferred" {% if (task.status or 'not_started') == 'deferred' %}selected{% endif %}>⏭️ Defer</option>
                                            </select>
                                        </div>
                                        {% else %}
                                        <div class="status-display">
                                            {% set status = task.status or 'not_started' %}
                                            {% if status == 'not_started' %}📋 Not Started
                                            {% elif status == 'in_progress' %}🔄 In Progress
                                            {% elif status == 'completed' %}✅ Completed
                                            {% elif status == 'deferred' %}⏭️ Deferred
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div style="flex: 1;">
                                        <div class="task-description" style="font-weight: 500; margin-bottom: 0.5rem;">
                                            {{ task.task_description }}
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs" style="padding: 0.25rem 0.5rem; background: rgba(255,255,255,0.2); color: inherit; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3);">
                                                {{ task.day_intensity|title }} Day
                                            </span>
                                            {% if task.priority %}
                                            <span class="task-priority {{ task.priority or 'medium' }}">{{ (task.priority or 'medium')|title }}</span>
                                            {% endif %}
                                            <span class="task-status-badge status-{{ task.status or 'not_started' }}">
                                                {% set status = task.status or 'not_started' %}
                                                {% if status == 'not_started' %}Not Started
                                                {% elif status == 'in_progress' %}In Progress
                                                {% elif status == 'completed' %}Completed
                                                {% elif status == 'deferred' %}Deferred
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% set has_incomplete_tasks = day_tasks|selectattr('completed', 'equalto', false)|list|length > 0 %}
                    {% if is_today or (selected_date < today and has_incomplete_tasks) %}
                        <div class="form-group" style="margin-top: 2rem;">
                            <label for="notes">💭 Notes about {% if is_today %}today's{% else %}this day's{% endif %} work:</label>
                            <textarea id="notes" name="notes" rows="4" 
                                      placeholder="What did you accomplish? Any challenges? Insights from your reading?"></textarea>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%; margin-top: 1rem;">
                            {% if is_today %}
                                ✨ Submit Today's Progress
                            {% else %}
                                📝 Update Progress for {{ selected_date.strftime('%B %d') }}
                            {% endif %}
                        </button>
                    {% endif %}
                </form>
            {% else %}
                <div class="text-center" style="padding: 2rem; background: var(--gray-50); border-radius: var(--border-radius);">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">📅</div>
                    <p style="margin: 0; font-weight: 500;">No tasks scheduled for this day</p>
                    <p class="text-sm opacity-75" style="margin: 0.5rem 0 0 0;">
                        This might be a rest day or outside your working schedule.
                    </p>
                </div>
            {% endif %}
        </div>
        
        <div>
            <h3>⚡ Day Settings</h3>
            <div style="background: var(--gray-50); padding: 1.5rem; border-radius: var(--border-radius);">
                <form method="POST" action="{{ url_for('update_day_intensity') }}">
                    <input type="hidden" name="date" value="{{ selected_date.strftime('%Y-%m-%d') }}">
                    
                    <label style="margin-bottom: 1rem; display: block;">Change day intensity:</label>
                    
                    {% set current_intensity = day_tasks[0].day_intensity if day_tasks else 'none' %}
                    
                    <div class="custom-select">
                        <select name="intensity">
                            <option value="none" {% if current_intensity == 'none' %}selected{% endif %}>
                                No Work Day - Rest day, no tasks scheduled
                            </option>
                            <option value="light" {% if current_intensity == 'light' %}selected{% endif %}>
                                Light Work Day - Regular workload (1 task)
                            </option>
                            <option value="heavy" {% if current_intensity == 'heavy' %}selected{% endif %}>
                                Heavy Work Day - Double workload (2 tasks)
                            </option>
                        </select>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: var(--border-radius); border-left: 4px solid var(--primary-color);">
                        <div class="flex items-center gap-2 mb-2">
                            <div style="width: 12px; height: 12px; background: var(--gray-400); border-radius: 50%;"></div>
                            <strong class="text-sm">No Work:</strong>
                            <span class="text-sm opacity-75">Complete rest day</span>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <div style="width: 12px; height: 12px; background: var(--accent-color); border-radius: 50%;"></div>
                            <strong class="text-sm">Light Day:</strong>
                            <span class="text-sm opacity-75">1 task scheduled</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div style="width: 12px; height: 12px; background: var(--secondary-color); border-radius: 50%;"></div>
                            <strong class="text-sm">Heavy Day:</strong>
                            <span class="text-sm opacity-75">2 tasks scheduled</span>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-secondary" style="width: 100%; margin-top: 1rem;">
                        🔄 Update Day Intensity
                    </button>
                </form>
            </div>
            
            {% if selected_date > today %}
                <div style="background: #fffbeb; border: 1px solid #fed7aa; color: #92400e; padding: 1rem; border-radius: var(--border-radius); margin-top: 1rem;">
                    <strong>📅 Future Date</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                        This date is in the future. You can adjust the intensity, but task completion will be available when the date arrives.
                    </p>
                </div>
            {% elif selected_date < today %}
                {% set has_incomplete_tasks = day_tasks|selectattr('completed', 'equalto', false)|list|length > 0 %}
                <div style="background: {% if has_incomplete_tasks %}#fffbeb; border: 1px solid #fed7aa; color: #92400e{% else %}#f0fdf4; border: 1px solid #bbf7d0; color: #166534{% endif %}; padding: 1rem; border-radius: var(--border-radius); margin-top: 1rem;">
                    <strong>📚 Past Date</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                        {% if has_incomplete_tasks %}
                            You can still mark incomplete tasks as completed and add notes about work you did on this day.
                        {% else %}
                            All tasks for this day are completed. You can still adjust intensity for schedule planning.
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function updateTaskStatus(taskId, newStatus) {
    const originalSelect = document.querySelector(`select[onchange*="${taskId}"]`);
    const originalValue = originalSelect.value;
    
    fetch('{{ url_for("update_task_status") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `task_id=${taskId}&status=${newStatus}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const container = document.getElementById('task-container-' + taskId);
            const statusBadge = container.querySelector('.task-status-badge');
            
            // Update container class
            container.className = container.className.replace(/task-status-\w+/, `task-status-${data.status}`);
            
            // Update status badge
            if (statusBadge) {
                statusBadge.className = statusBadge.className.replace(/status-\w+/, `status-${data.status}`);
                const statusText = {
                    'not_started': 'Not Started',
                    'in_progress': 'In Progress', 
                    'completed': 'Completed',
                    'deferred': 'Deferred'
                };
                statusBadge.textContent = statusText[data.status];
            }
            
            // Show message for deferred tasks
            if (data.status === 'deferred' && data.new_date) {
                const newDate = new Date(data.new_date).toLocaleDateString();
                showNotification(`Task deferred to ${newDate}`, 'info');
            } else if (data.status === 'in_progress') {
                showNotification('Task marked as in progress! Keep going! 💪', 'success');
            } else if (data.status === 'completed') {
                showNotification('Great job completing this task! 🎉', 'success');
            }
            
            // Update quick actions visibility
            updateQuickActionsVisibility();
        } else {
            alert('Error updating task: ' + data.error);
            // Revert select value
            originalSelect.value = originalValue;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating task. Please try again.');
        // Revert select value
        originalSelect.value = originalValue;
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-md);
        color: white;
        font-weight: 500;
        max-width: 300px;
        animation: slideIn 0.3s ease;
    `;
    
    if (type === 'success') {
        notification.style.background = 'var(--success-color)';
    } else if (type === 'info') {
        notification.style.background = 'var(--primary-color)';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Legacy function for backward compatibility
function toggleTaskCompletion(taskId, isCompleted) {
    updateTaskStatus(taskId, isCompleted ? 'completed' : 'not_started');
}

function markAllTasksComplete() {
    if (confirm('Mark all tasks for this day as complete?')) {
        const selects = document.querySelectorAll('.task-status-select');
        selects.forEach(select => {
            if (select.value !== 'completed') {
                const taskId = select.getAttribute('onchange').match(/\d+/)[0];
                select.value = 'completed';
                updateTaskStatus(taskId, 'completed');
            }
        });
    }
}

function markAllTasksIncomplete() {
    if (confirm('Mark all tasks for this day as not started?')) {
        const selects = document.querySelectorAll('.task-status-select');
        selects.forEach(select => {
            if (select.value !== 'not_started') {
                const taskId = select.getAttribute('onchange').match(/\d+/)[0];
                select.value = 'not_started';
                updateTaskStatus(taskId, 'not_started');
            }
        });
    }
}

function updateQuickActionsVisibility() {
    const quickActions = document.querySelector('.task-quick-actions');
    if (quickActions) {
        const incompleteSelects = document.querySelectorAll('.task-status-select');
        let hasIncomplete = false;
        
        incompleteSelects.forEach(select => {
            if (select.value !== 'completed') {
                hasIncomplete = true;
            }
        });
        
        if (!hasIncomplete) {
            quickActions.style.display = 'none';
        } else {
            quickActions.style.display = 'block';
        }
    }
}

// Legacy function for form compatibility
function updateTaskContainer(taskId) {
    const container = document.getElementById('task-container-' + taskId);
    const checkbox = document.getElementById('task_' + taskId);
    
    if (checkbox.checked) {
        container.classList.add('completed');
    } else {
        container.classList.remove('completed');
    }
}

// Set today variable for template
const today = new Date('{{ today.strftime('%Y-%m-%d') if today is defined else datetime.now().date().strftime('%Y-%m-%d') }}');
</script>
{% endblock %}